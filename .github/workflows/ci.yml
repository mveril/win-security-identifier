name: Rust CI

on:
  push:
    branches: [main, develop, 'release/*']
  pull_request:
    branches: [main, develop, 'release/*']
  schedule:
    - cron: '0 3 * * 0'  # weekly audit

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  # ============================================================
  # 1) std job: audit build test...
  # ============================================================
  build-test-std:
    name: Build & test (${{ matrix.os }}, ${{ matrix.toolchain }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        toolchain: [stable, nightly]
    env:
      CARGO_TERM_COLOR: always
      RUSTFLAGS: -D warnings
      RUSTDOCFLAGS: -D warnings
      CARGO_INCREMENTAL: 0

    steps:
      # --------------------------- Checkout ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------- Toolchain setup -----------------------------
      - name: Set up Rust toolchain (${{ matrix.toolchain }})
        run: |
          rustup set profile minimal
          rustup update ${{ matrix.toolchain }}
          rustup default ${{ matrix.toolchain }}
          rustup component add rustfmt clippy

      # --------------------------- Cache ---------------------------------------
      - name: Cache cargo registries, target and advisory DB
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/advisory-db
            target
          key: ${{ runner.os }}-cargo-${{ matrix.toolchain }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.toolchain }}-
            ${{ runner.os }}-cargo-

      - name: Show Rust versions
        run: |
          rustc -Vv
          cargo -V

      # --------------------------- Security audit (Ubuntu stable only) ---------
      - name: Install cargo-audit (ubuntu-nightly only)
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.toolchain == 'nightly' }}
        run: |
          cargo install --locked cargo-audit || echo "cargo-audit already installed"

      - name: Run cargo audit (ubuntu-nightly only)
        if: ${{ matrix.os == 'ubuntu-latest' && matrix.toolchain == 'nightly' }}
        run: cargo audit

      # --------------------------- Lints & tests -------------------------------
      - name: Check code format
        run: cargo fmt --all -- --check

      - name: Run Clippy (deny warnings)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Build workspace
        run: cargo build --workspace --all-features

      - name: Run tests
        run: cargo test --workspace --all-features --all-targets -- --nocapture



  # ============================================================
  # 2) no_std job: detection (Nushell) + compile (core & alloc)
  # ============================================================
  no-std:
    name: no_std (Nu detect core/alloc → build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nushell (apt → snap → cargo fallback)
        run: |
          set -e
          if command -v nu >/dev/null 2>&1; then exit 0; fi
          if sudo apt-get update -y && sudo apt-get install -y nushell; then exit 0; fi
          if command -v snap >/dev/null 2>&1; then
            sudo snap install nushell --classic || true
          fi
          if ! command -v nu >/dev/null 2>&1; then
            rustup set profile minimal
            rustup update stable
            cargo install nu
          fi
          nu -c '$nu.version'

      - name: Toolchain + targets
        run: |
          rustup set profile minimal
          rustup update stable
          rustup default stable
          # Bare-metal no_std target for compile-only checks
          rustup target add x86_64-unknown-none

      # --------------------------
      # Step: detect-nostd (Nushell)
      # - Find workspace lib packages
      # - Build CORE args per package:
      #     --no-default-features [--features feat1,feat2,...] (all non-std/non-alloc)
      # Outputs (compact JSON):
      #   TARGET_BARE     -> "x86_64-unknown-none"
      #   CORE_MATRIX     -> [{"pkg":"name","args":"..."}]
      #   PKG_LIST        -> ["pkg1","pkg2",...]
      # --------------------------
      - name: detect-nostd (Nu)
        id: detect-nostd
        shell: bash
        run: |
          set -euo pipefail
          nu -c '
            # --- read cargo metadata as structured data ---
            let meta = (cargo metadata --no-deps --format-version=1 | from json)

            # --- select workspace members that have at least one lib target ---
            let pkgs = ($meta.packages
              | where {|p| $meta.workspace_members | any {|id| $id == $p.id } }
              | where {|p| $p.targets | any {|t| $t.kind | any {|k| $k == "lib"} } }
              | get name
              | uniq
            )

            # --- build core args per package (all non-std/non-alloc features) ---
            let core_matrix = ($pkgs | each {|name|
              let feats = ($meta.packages
                | where name == $name
                | get 0
                | get features
                | columns
                | where {|f| $f != "default" and $f != "std" and $f != "alloc"}
                | str join ","
              )
              let args = if ($feats | is-empty) { "--no-default-features" } else { $"--no-default-features --features ($feats)" }
              { pkg: $name, args: $args }
            })

            # --- outputs (compact JSON, single-line) ---
            $"TARGET_BARE=x86_64-unknown-none" | save --append $env.GITHUB_OUTPUT
            $"PKG_LIST=($pkgs | to json -c)"     | save --append $env.GITHUB_OUTPUT
            $"CORE_MATRIX=($core_matrix | to json -c)" | save --append $env.GITHUB_OUTPUT
          '

      # --------------------------
      # Step: detect-alloc (Nushell)
      # - For packages that have an "alloc" feature, build ALLOC args:
      #     --no-default-features --features alloc[,feat1,feat2,...non-std/non-alloc]
      # Output:
      #   ALLOC_MATRIX   -> [{"pkg":"name","args":"..."}]
      # --------------------------
      - name: detect-alloc (Nu)
        id: detect-alloc
        shell: bash
        run: |
          set -euo pipefail
          nu -c '
            let meta = (cargo metadata --no-deps --format-version=1 | from json)
            let pkgs = ($env.PKG_LIST | from json)  # from previous step outputs

            let alloc_matrix = ($pkgs | each {|name|
              let feats_cols = ($meta.packages | where name == $name | get 0 | get features | columns)
              if ($feats_cols | any {|f| $f == "alloc"}) {
                let extra = ($feats_cols
                  | where {|f| $f != "default" and $f != "std" and $f != "alloc"}
                  | str join ","
                )
                let args = if ($extra | is-empty) {
                  "--no-default-features --features alloc"
                } else {
                  $"--no-default-features --features alloc,($extra)"
                }
                { pkg: $name, args: $args }
              }
            } | compact)

            $"ALLOC_MATRIX=($alloc_matrix | to json -c)" | save --append $env.GITHUB_OUTPUT
          '

      # --------------------------
      # Build: no_std (core + alloc) using Bash (reads compact JSON outputs)
      # --------------------------
      - name: Cargo check (no_std)
        shell: bash
        run: |
          set -euo pipefail
          TARGET='${{ steps.detect-nostd.outputs.TARGET_BARE }}'
          FINAL=$(jq -cn \
            --argjson core '${{ steps.detect-nostd.outputs.CORE_MATRIX }}' \
            --argjson alloc '${{ steps.detect-alloc.outputs.ALLOC_MATRIX || "[]" }}' \
            '$core + $alloc')
          echo "${FINAL}" | jq -c '.[]' | while read -r row; do
            PKG=$(echo "$row"  | jq -r '.pkg')
            ARGS=$(echo "$row" | jq -r '.args')
            echo ">> check: ${PKG} @ ${TARGET} (${ARGS})"
            cargo check -p "${PKG}" --target "${TARGET}" ${ARGS}
          done

      - name: Cargo build (no_std, release)
        shell: bash
        run: |
          set -euo pipefail
          TARGET='${{ steps.detect-nostd.outputs.TARGET_BARE }}'
          FINAL=$(jq -cn \
            --argjson core '${{ steps.detect-nostd.outputs.CORE_MATRIX }}' \
            --argjson alloc '${{ steps.detect-alloc.outputs.ALLOC_MATRIX || "[]" }}' \
            '$core + $alloc')
          echo "${FINAL}" | jq -c '.[]' | while read -r row; do
            PKG=$(echo "$row"  | jq -r '.pkg')
            ARGS=$(echo "$row" | jq -r '.args')
            echo ">> build: ${PKG} @ ${TARGET} (${ARGS})"
            cargo build -p "${PKG}" --release --target "${TARGET}" ${ARGS}
          done

      # --------------------------
      # Build: no_std (core + alloc)
      # --------------------------
      - name: Cargo check (no_std)
        shell: bash
        run: |
          set -euo pipefail
          TARGET='${{ steps.detect-nostd.outputs.TARGET }}'

          FINAL=$(jq -cn \
            --argjson core '${{ steps.detect-nostd.outputs.CORE_MATRIX }}' \
            --argjson alloc '${{ steps.detect-alloc.outputs.ALLOC_MATRIX }}' \
            '$core + $alloc')

          echo "${FINAL}" | jq -c '.[]' | while read -r row; do
            PKG=$(echo "$row"  | jq -r '.pkg')
            ARGS=$(echo "$row" | jq -r '.args')
            echo ">> check: ${PKG} @ ${TARGET} (${ARGS})"
            cargo check -p "${PKG}" --target "${TARGET}" ${ARGS}
          done

      - name: Cargo build (no_std, release)
        shell: bash
        run: |
          set -euo pipefail
          TARGET='${{ steps.detect-nostd.outputs.TARGET }}'

          FINAL=$(jq -cn \
            --argjson core '${{ steps.detect-nostd.outputs.CORE_MATRIX }}' \
            --argjson alloc '${{ steps.detect-alloc.outputs.ALLOC_MATRIX }}' \
            '$core + $alloc')

          echo "${FINAL}" | jq -c '.[]' | while read -r row; do
            PKG=$(echo "$row"  | jq -r '.pkg')
            ARGS=$(echo "$row" | jq -r '.args')
            echo ">> build: ${PKG} @ ${TARGET} (${ARGS})"
            cargo build -p "${PKG}" --release --target "${TARGET}" ${ARGS}
          done
